# User Registration Service Demo

A demonstration project showcasing shift-left testing with Testcontainers, focusing on email case-sensitivity bug detection.

## Project Structure

Express.js backend with TypeORM for database access
Jest for testing
Testcontainers for integration tests
Three levels of tests: Unit, Integration, and E2E


The Bug:
Email uniqueness check is case-sensitive
Could allow duplicate registrations with different cases (e.g., user@example.com and USER@example.com)
Real-world issue that could cause authentication problems

Code generated by Claude 3.5 Sonnet (feel free to change it):
// package.json
{
  "name": "user-registration-demo",
  "version": "1.0.0",
  "description": "Demo project for shift-left testing with Testcontainers",
  "main": "dist/index.js",
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "ts-node src/index.ts",
    "test": "jest",
    "test:unit": "jest --testPathPattern=unit",
    "test:integration": "jest --testPathPattern=integration",
    "test:e2e": "jest --testPathPattern=e2e"
  },
  "dependencies": {
    "express": "^4.18.2",
    "pg": "^8.11.3",
    "typeorm": "^0.3.20"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/jest": "^29.5.12",
    "@types/node": "^20.11.16",
    "@types/pg": "^8.11.0",
    "@types/supertest": "^6.0.2",
    "jest": "^29.7.0",
    "supertest": "^6.3.4",
    "testcontainers": "^10.7.1",
    "ts-jest": "^29.1.2",
    "ts-node": "^10.9.2",
    "typescript": "^5.3.3"
  }
}

// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true
  }
}

// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  testMatch: ['**/*.test.ts'],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1'
  }
};

// src/entity/User.ts
import { Entity, PrimaryGeneratedColumn, Column } from "typeorm";

@Entity()
export class User {
    @PrimaryGeneratedColumn()
    id!: number;

    @Column({ unique: true })
    email!: string;

    @Column()
    username!: string;

    @Column()
    status!: string;
}

// src/service/EmailService.ts
export class EmailService {
    async sendVerificationEmail(email: string): Promise<void> {
        // Simulate email sending with network delay
        await new Promise(resolve => setTimeout(resolve, 100));
    }
}

// src/service/UserService.ts
import { Repository } from "typeorm";
import { User } from "../entity/User";
import { EmailService } from "./EmailService";

export class UserRegistrationService {
    constructor(
        private userRepository: Repository<User>,
        private emailService: EmailService
    ) {}

    async registerUser(email: string, username: string): Promise<User> {
        if (!this.isValidEmail(email)) {
            throw new Error("Invalid email format");
        }

        // BUG: Case-sensitive email check
        const existingUser = await this.userRepository.findOne({
            where: { email }
        });

        if (existingUser) {
            throw new Error("Email already registered");
        }

        const user = new User();
        user.email = email.toLowerCase(); // Email is stored lowercase
        user.username = username;
        user.status = "PENDING";

        const savedUser = await this.userRepository.save(user);
        await this.emailService.sendVerificationEmail(email);

        return savedUser;
    }

    private isValidEmail(email: string): boolean {
        return email != null && /^[A-Za-z0-9+_.-]+@(.+)$/.test(email);
    }
}

// src/tests/unit/UserService.test.ts
import { User } from "../../entity/User";
import { UserRegistrationService } from "../../service/UserService";
import { EmailService } from "../../service/EmailService";
import { Repository } from "typeorm";

describe("UserRegistrationService - Unit Tests", () => {
    let userService: UserRegistrationService;
    let mockUserRepository: jest.Mocked<Repository<User>>;
    let mockEmailService: jest.Mocked<EmailService>;

    beforeEach(() => {
        mockUserRepository = {
            findOne: jest.fn(),
            save: jest.fn(),
        } as any;

        mockEmailService = {
            sendVerificationEmail: jest.fn(),
        } as any;

        userService = new UserRegistrationService(
            mockUserRepository,
            mockEmailService
        );
    });

    it("should validate email format", async () => {
        await expect(
            userService.registerUser("invalid-email", "username")
        ).rejects.toThrow("Invalid email format");
    });

    it("should register valid user", async () => {
        const email = "test@example.com";
        const username = "testuser";

        mockUserRepository.findOne.mockResolvedValue(null);
        mockUserRepository.save.mockImplementation(user => Promise.resolve({
            ...user,
            id: 1
        } as User));

        const result = await userService.registerUser(email, username);

        expect(result.email).toBe(email);
        expect(result.username).toBe(username);
        expect(mockEmailService.sendVerificationEmail).toHaveBeenCalledWith(email);
    });
});

// src/tests/integration/UserService.integration.test.ts
import { StartedPostgreSqlContainer, PostgreSqlContainer } from 'testcontainers';
import { DataSource } from "typeorm";
import { User } from "../../entity/User";
import { UserRegistrationService } from "../../service/UserService";
import { EmailService } from "../../service/EmailService";

describe("UserRegistrationService - Integration Tests", () => {
    let container: StartedPostgreSqlContainer;
    let dataSource: DataSource;
    let userService: UserRegistrationService;
    
    beforeAll(async () => {
        // Start PostgreSQL container
        container = await new PostgreSqlContainer()
            .withDatabase("testdb")
            .withUsername("test")
            .withPassword("test")
            .start();

        // Initialize TypeORM connection
        dataSource = new DataSource({
            type: "postgres",
            host: container.getHost(),
            port: container.getPort(),
            username: container.getUsername(),
            password: container.getPassword(),
            database: container.getDatabase(),
            entities: [User],
            synchronize: true
        });

        await dataSource.initialize();
        
        const emailService = new EmailService();
        userService = new UserRegistrationService(
            dataSource.getRepository(User),
            emailService
        );
    });

    afterAll(async () => {
        await dataSource.destroy();
        await container.stop();
    });

    it("should not allow duplicate emails regardless of case", async () => {
        const startTime = Date.now();

        // First registration
        await userService.registerUser("test@example.com", "user1");

        // Second registration with different case
        await expect(
            userService.registerUser("TEST@example.com", "user2")
        ).rejects.toThrow("Email already registered");

        const endTime = Date.now();
        console.log(`Integration test execution time: ${endTime - startTime}ms`);
    });

    it("should store email in lowercase", async () => {
        const user = await userService.registerUser("TEST@example.com", "user1");
        expect(user.email).toBe("test@example.com");
    });
});

// src/tests/e2e/UserRegistration.e2e.test.ts
import { Express } from 'express';
import request from 'supertest';
import { StartedPostgreSqlContainer, PostgreSqlContainer } from 'testcontainers';
import { createApp } from '../../app';
import { DataSource } from "typeorm";
import { User } from "../../entity/User";

describe("User Registration - E2E Tests", () => {
    let app: Express;
    let container: StartedPostgreSqlContainer;
    let dataSource: DataSource;

    beforeAll(async () => {
        const startTime = Date.now();

        // Start PostgreSQL container
        container = await new PostgreSqlContainer()
            .withDatabase("testdb")
            .withUsername("test")
            .withPassword("test")
            .start();

        // Initialize TypeORM connection
        dataSource = new DataSource({
            type: "postgres",
            host: container.getHost(),
            port: container.getPort(),
            username: container.getUsername(),
            password: container.getPassword(),
            database: container.getDatabase(),
            entities: [User],
            synchronize: true
        });

        await dataSource.initialize();
        
        // Create Express app
        app = createApp(dataSource);

        const endTime = Date.now();
        console.log(`E2E test setup time: ${endTime - startTime}ms`);
    });

    afterAll(async () => {
        await dataSource.destroy();
        await container.stop();
    });

    it("should register users and miss the case-sensitivity bug", async () => {
        const startTime = Date.now();

        // First registration
        const response1 = await request(app)
            .post("/api/users/register")
            .send({
                email: "test@example.com",
                username: "user1"
            });
        
        expect(response1.status).toBe(200);

        // Second registration with different case - this will pass but shouldn't!
        const response2 = await request(app)
            .post("/api/users/register")
            .send({
                email: "TEST@example.com",
                username: "user2"
            });
        
        // E2E test misses the bug because it's not checking for case-insensitive duplicates
        expect(response2.status).toBe(200);

        const endTime = Date.now();
        console.log(`E2E test execution time: ${endTime - startTime}ms`);
    });
});

// src/app.ts
import express from "express";
import { DataSource } from "typeorm";
import { User } from "./entity/User";
import { UserRegistrationService } from "./service/UserService";
import { EmailService } from "./service/EmailService";

export function createApp(dataSource: DataSource) {
    const app = express();
    app.use(express.json());

    const userRepository = dataSource.getRepository(User);
    const emailService = new EmailService();
    const userService = new UserRegistrationService(userRepository, emailService);

    app.post("/api/users/register", async (req, res) => {
        try {
            const { email, username } = req.body;
            const user = await userService.registerUser(email, username);
            res.json(user);
        } catch (error) {
            res.status(400).json({ error: (error as Error).message });
        }
    });

    return app;
}

// src/index.ts
import { DataSource } from "typeorm";
import { User } from "./entity/User";
import { createApp } from "./app";

async function main() {
    const dataSource = new DataSource({
        type: "postgres",
        host: "localhost",
        port: 5432,
        username: "postgres",
        password: "postgres",
        database: "userdb",
        entities: [User],
        synchronize: true
    });

    await dataSource.initialize();
    
    const app = createApp(dataSource);
    const port = process.env.PORT || 3000;
    
    app.listen(port, () => {
        console.log(`Server is running on port ${port}`);
    });
}

main().catch(console.error);